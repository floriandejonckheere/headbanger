#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../config/environment"
require_relative "../config/boot"

log_target = Rails.env.development? ? $stdout : Rails.root.join("logs/scrub.log")
Rails.logger = Logger.new(log_target)
Rails.logger.level = ENV.fetch("LOG_LEVEL", Logger::DEBUG)

loop do
  Rails.logger.debug "Scrubbing data..."

  Scrub.new.call
rescue StandardError => e
  Rails.logger.error(e)
  Raven.capture_exception(e)

  raise e
ensure
  sleep Headbanger.config.sync_interval
end
